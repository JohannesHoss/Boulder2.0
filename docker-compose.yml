version: "3.8"

# Boulder Deployment Configuration
# This compose file is used in TWO directories:
# - ~/apps/boulder-pre/ (tracks 'pre' branch) -> uses ENV=pre
# - ~/apps/boulder-main/ (tracks 'main' branch) -> uses ENV=main
#
# The BOULDER_ENV variable determines which hostnames to use.
# Set via: BOULDER_ENV=pre docker compose up -d --build
# Or via deploy.sh which sets it automatically based on directory name.

services:
  boulder-frontend:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        ENVIRONMENT: ${BOULDER_ENV:-main}
    container_name: boulder-${BOULDER_ENV:-main}-frontend
    restart: unless-stopped
    networks:
      - web
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.boulder-${BOULDER_ENV:-main}.rule=Host(`${BOULDER_FRONTEND_HOST:-boulder.varga.media}`)"
      - "traefik.http.routers.boulder-${BOULDER_ENV:-main}.entrypoints=web"
      - "traefik.http.services.boulder-${BOULDER_ENV:-main}.loadbalancer.server.port=80"
      - "traefik.docker.network=web"

  boulder-api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: boulder-${BOULDER_ENV:-main}-api
    restart: unless-stopped
    volumes:
      - boulder-${BOULDER_ENV:-main}-data:/data
    networks:
      - web
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.boulder-${BOULDER_ENV:-main}-api.rule=Host(`${BOULDER_API_HOST:-boulder-api.varga.media}`)"
      - "traefik.http.routers.boulder-${BOULDER_ENV:-main}-api.entrypoints=web"
      - "traefik.http.services.boulder-${BOULDER_ENV:-main}-api.loadbalancer.server.port=3001"
      - "traefik.docker.network=web"

networks:
  web:
    external: true

volumes:
  boulder-main-data:
    name: boulder-main-data
  boulder-pre-data:
    name: boulder-pre-data
